# HƯỚNG DẪN SYNC 2 CHIỀU RATE PLAN & PRODUCT VỚI MEWS PMS

## PHẦN 1 – SYNC & PUSH RATE PLAN (Sale Plan) VỚI MEWS

| Nhóm                        | Hành động                          | Endpoint                                             | Method | Mô tả chính                                                                                           | Parameters nổi bật                                                                                                     | Limits & Notes                                                                                               |
|-----------------------------|------------------------------------|------------------------------------------------------|--------|-------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|
| **Sync chủ động (Pull)**    | Lấy tất cả rate plan               | `/api/connector/v1/rates/getAll`                     | GET    | Lấy toàn bộ hoặc incremental rate plan từ Mews về hệ thống bạn                                       | `ServiceIds`, `UpdatedUtc` (incremental), `ExternalIdentifiers` (match plan của bạn)                                   | Max 1000 rates/response, pagination qua `Limitation`                                                         |
|                             | Lấy chi tiết giá theo ngày         | `/api/connector/v1/rates/getPricing`                | GET    | Lấy giá daily/weekly của một rate plan                                                                | `RateId`, `FirstTimeUnitStartUtc`, `LastTimeUnitStartUtc` (max 367 ngày)                                                | Dùng cho dependent rates                                                                                     |
| **Webhook (Real-time Pull)**| Rate plan thay đổi                 | Event: `RateChanged`                                 | POST   | Mews tự động đẩy khi rate plan bị tạo/sửa/xóa                                                         | Payload: `RateId`, `ServiceId`, `Changes`, `TimestampUtc`                                                              | Verify HMAC signature, trả 200 ngay                                                                   |
|                             | Giá trong rate plan thay đổi       | Event: `PriceUpdated`                                | POST   | Khi giá theo khoảng thời gian bị thay đổi                                                            | Payload: `RateId`, `PriceUpdates` (array)                                                                              | Trigger sync tức thì                                                                                  |
| **Push rate plan lên Mews** | Tạo mới bulk rate plan             | `/api/connector/v1/rates/add`                        | POST   | Tạo mới nhiều rate plan từ hệ thống bạn                                                               | `Rates` (array): `ServiceId`, `PricingType`, `BaseRateId` (nếu dependent)                                              | Max 1000 rates/request                                                                                       |
|                             | Upsert (tạo hoặc update) – KHUYẾN CÁO | `/api/connector/v1/rates/set` (Beta)                 | POST   | TỐT NHẤT cho 2-way sync: match bằng ExternalIdentifier                                                | `Rates` (array): thêm `ExternalIdentifier` (ID plan của bạn), `ServiceId`, `Pricing`                                   | Max 100 rates/request – dùng cái này là chuẩn nhất cho sync 2 chiều                                         |
|                             | Cập nhật giá theo ngày             | `/api/connector/v1/rates/updatePrice`               | POST   | Push giá mới cho base rate → tự động ảnh hưởng các dependent rates                                    | `RateId`, `PriceUpdates` (array): `Value`, `First/LastTimeUnitStartUtc`                                                | Max 1000 updates/request, chỉ future prices                                                                  |
|                             | Điều chỉnh occupancy theo plan     | `/api/connector/v1/rates/updateCapacityOffset`      | POST   | Dynamic pricing theo occupancy                                                                        | `CapacityOffsetUpdates` (array): `RateId`, `NegativeOccupancyAdjustment`, `ExtraOccupancyAdjustment`                  | Max 50 updates/request                                                                                       |

## PHẦN 2 – SYNC & PUSH PRODUCT (Service / Resource Category) TRONG RATE PLAN

| Nhóm                        | Hành động                          | Endpoint                                             | Method | Mô tả chính                                                                                           | Parameters nổi bật                                                                                                     | Limits & Notes                                                                                               |
|-----------------------------|------------------------------------|------------------------------------------------------|--------|-------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|
| **Sync chủ động (Pull)**    | Lấy tất cả product/service         | `/api/connector/v1/services/getAll`                  | GET    | Lấy danh sách phòng/loại phòng/dịch vụ từ Mews                                                        | `ServiceIds`, `UpdatedUtc` (incremental)                                                                               | Pagination, dùng để map product của bạn ↔ ServiceId trong Mews                                              |
|                             | Lấy chi tiết resource category     | `/api/connector/v1/resourceCategories/getAll`       | GET    | Lấy các loại phòng (Deluxe, Standard…)                                                                | `ServiceId` (filter theo property)                                                                                     | Thường dùng để biết CategoryId khi push giá                                                                  |
| **Webhook (Real-time Pull)**| Product/service thay đổi           | Event: `ServiceUpdated`                              | POST   | Khi thông tin service (tên, category, rate liên kết…) thay đổi                                        | Payload: `ServiceId`, `Changes`                                                                                        | Trigger khi product bị chỉnh sửa ở Mews                                                                      |
| **Push product lên Mews**   | Tạo mới service (hiếm dùng)        | `/api/connector/v1/services/add`                     | POST   | Tạo service mới (thường đã có sẵn trong Mews)                                                         | `Name`, `ResourceCategoryId`, `AccountingCategoryId`                                                                   | Restricted – cần quyền cao                                                                                   |
|                             | Cập nhật service                   | `/api/connector/v1/services/update`                 | POST   | Cập nhật tên, category, hoặc link rate plan                                                           | `ServiceId`, `Name`, `ResourceCategoryId`                                                                              | Thường chỉ cần khi mapping thay đổi                                                                          |
|                             | Gắn rate plan vào nhiều product   | Dùng `/rates/add` hoặc `/rates/set` (Phần 1)         | POST   | Cách chính: khi tạo/upsert rate plan, chỉ định ServiceId của các product cần gắn                     | `ServiceId` (array trong payload Rates)                                                                                | Đây là cách chuẩn để “assign nhiều product vào 1 rate plan”                                                 |
|                             | Cập nhật giá theo Resource Category| `/api/connector/v1/rates/updatePrice` (Phần 1)       | POST   | Push giá cho toàn bộ loại phòng (Deluxe, Standard…) cùng lúc                                         | `ResourceCategoryIds` (array trong PriceUpdates)                                                                       | Rất mạnh khi 1 plan áp dụng cho nhiều loại phòng                                                            |

## GHI CHÚ QUAN TRỌNG
- Luôn dùng `ExternalIdentifier` trong `/rates/set` để map 1-1 giữa **sale plan của bạn** ↔ **rate trong Mews**.
- Kết hợp webhook `RateChanged` + `PriceUpdated` để sync real-time.
- Incremental sync: lưu `UpdatedUtc` mới nhất sau mỗi lần pull.
- Test trước ở https://demo.mews.com