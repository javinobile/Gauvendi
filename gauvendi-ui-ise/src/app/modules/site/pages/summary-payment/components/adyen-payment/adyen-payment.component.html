<div class="mt-[12px] p-[24px] bg-background-secondary-color rounded-[24px] sm:p-[16px]">
  <div class="text-[17px] font-medium leading-[140%] text-primary-color mb-[12px]">{{ 'PAYMENT_METHODS' | translate | async }}</div>
  <div class="flex flex-col gap-[8px]">
    <ng-container *ngFor="let paymentMode of availablePaymentMethodList">
      <ng-container *ngIf="!(paymentMode.paymentMethodCode | getPaymentModeStatus: summaryBooking?.payOnConfirmationAmount)">
        <div
          class="py-[16px] rounded-[16px] px-[20px] bg-background-primary-color relative sm:px-[16px] cursor-pointer"
          [ngClass]="{ 'border border-hotel-primary-color': selectedPaymentMethodCode === paymentMode.paymentMethodCode }"
          (click)="onPaymentMethodChange(paymentMode?.paymentMethodCode)"
        >
          <div class="absolute ltr:right-[20px] rtl:left-[20px] top-[20px]">
            <mat-icon class="text-hotel-primary-color">
              {{ selectedPaymentMethodCode === paymentMode.paymentMethodCode ? 'check_circle' : 'radio_button_unchecked' }}
            </mat-icon>
          </div>
          <div class="flex items-center gap-[16px]">
            <div class="py-[8px] px-[10px] w-[46px] h-[32px] border border-border-color rounded-[8px] flex items-center justify-center">
              <img loading="lazy" [src]="paymentMode?.paymentMethodCode | getPaymentMethodIcon" alt="" class="h-[20px]" />
            </div>
            <div class="text-[14px] font-medium leading-[140%] text-primary-color">
              {{
                paymentMode?.paymentMethodCode === hotelPaymentModeCode?.Pmdoth
                  ? paymentMode?.paymentMethodDetailsList?.[0]?.metadata?.metadata?.['customName']
                  : (paymentMode?.paymentMethodCode | parsePaymentMethodName: +summaryBooking?.payOnConfirmationAmount | translate | async)
              }}
            </div>
          </div>
          <mat-expansion-panel [expanded]="selectedPaymentMethodCode === paymentMode.paymentMethodCode" class="payment-content">
            <ng-container [ngSwitch]="paymentMode.paymentMethodCode">
              <ng-container *ngSwitchCase="hotelPaymentModeCode.Guawcc">
                <ng-container *ngTemplateOutlet="tplPaymentWithCreditCard"></ng-container>
              </ng-container>
              <ng-container *ngSwitchDefault>
                <ng-container *ngTemplateOutlet="tplDefaultGuarantee; context: { $implicit: paymentMode }"></ng-container>
              </ng-container>
            </ng-container>
          </mat-expansion-panel>
        </div>
      </ng-container>
    </ng-container>
  </div>
</div>

<div class="mt-[40px] sm:mt-[16px] flex items-center gap-[12px] sm:flex-col sm:items-start md:flex-col lg:flex-col sm:px-[20px]">
  <div class="flex items-start sm:items-center gap-[8px] mb-[12px]">
    <app-checkbox-c [formControl]="termCtrl"> </app-checkbox-c>
    <div class="text-[14px] font-normal leading-[140%] text-primary-color">
      <span style="line-height: 1.5em">
        {{ 'MESSAGE_CONFIRM_PAYMENT_CERTIFY' | translate | async }}
        <a class="text-hotel-primary-color underline cursor-pointer font-medium" [href]="hotelTerm | parseMetadataConfig: locale" target="_blank">
          {{ 'MESSAGE_CONFIRM_PAYMENT_TERMS_OF_USE' | translate | async }}
        </a>
        {{ 'AND' | translate | async }}
        <a class="text-hotel-primary-color underline cursor-pointer font-medium" [href]="hotelPrivacy | parseMetadataConfig: locale" target="_blank">
          {{ 'MESSAGE_CONFIRM_PAYMENT_PRIVACY_STATEMENT' | translate | async }}
        </a>
        {{ 'MESSAGE_CONFIRM_PAYMENT_RATE_DESCRIPTION_RULE' | translate | async }}
      </span>
    </div>
  </div>
  <div class="flex items-center justify-end sm:mt-[16px] sm:w-full">
    <ng-container *ngIf="selectedPaymentMethodCode !== hotelPaymentModeCode.Paypal">
      <ng-container *ngIf="(isLockSubmitPayment$ | async) === false; else tplLoading">
        <button
          class="h-[44px] text-[14px] font-medium leading-[140%] whitespace-nowrap sm:items-center text-button-normal-color bg-button-normal-background-color rounded-[12px] px-[24px] sm:w-full sm:flex sm:justify-center hover:opacity-80"
          [disabled]="!summaryBooking || !termCtrl?.value || (selectedPaymentMethodCode === hotelPaymentModeCode.Guawcc && !(this.cardValid$ | async))"
          [ngClass]="{ '!bg-disabled-color !cursor-not-allowed': !summaryBooking || !termCtrl?.value || (selectedPaymentMethodCode === hotelPaymentModeCode.Guawcc && !(this.cardValid$ | async)) }"
          (click)="submitConfirmPayment()"
        >
          {{ 'CONFIRM_BOOKING' | translate | async }}
        </button>
      </ng-container>
    </ng-container>

    <div id="paypal-button-container" class="w-[200px] paypal-button-container" [class.hidden]="selectedPaymentMethodCode !== hotelPaymentModeCode.Paypal"></div>
  </div>
</div>

<div class="error-message sm:px-[20px] sm:mt-[12px]" *ngIf="paymentErrorMessage$ | async as paymentErrorMessage">
  <p>
    {{ paymentErrorMessage | translate | async }}
  </p>
  <p *ngIf="paymentErrorMessageDraw$ | async">{{ paymentErrorMessageDraw$ | async }}</p>
</div>

<div
  class="error-message sm:px-[20px] sm:mt-[12px]"
  *ngIf="!(guestInformationValid && additionalGuestValid) || (selectedPaymentMethodCode === hotelPaymentModeCode.Guawcc && !(this.cardValid$ | async))"
>
  <p *ngIf="validationErrorMessage$ | async">
    {{ validationErrorMessage$ | async | translate | async }}
  </p>
</div>

<ng-template #tplPaymentWithCreditCard>
  <div class="mt-[16px] bg-popover-background-color px-[20px] sm:px-0 py-[12px] rounded-[12px]">
    <div class="" #frmPayment>
      <ng-container [formGroup]="rfPayment">
        <div class="grid grid-cols-2 gap-x-[8px] gap-y-[16px]">
          <div class="col-span-1 sm:col-span-2">
            <div class="text-[14px] font-medium leading-[21px] text-primary-color mb-[2px]">{{ 'CARD_NUMBER' | translate | async }} <span class="text-field-required">*</span></div>
            <div
              #cardNumber
              id="card-number-placeholder"
              class="h-[40px] bg-background-primary-color rounded-[10px] px-[16px] py-[9.5px] border border-border-color"
              data-cse="encryptedCardNumber"
              [ngClass]="{
                'border-error-color': (isCardNumberFocus$ | async) && !(this.isCardNumberValid$ | async)
              }"
            ></div>
            <app-form-error *ngIf="(isCardNumberFocus$ | async) && !(this.isCardNumberValid$ | async)">
              {{ 'CARD_NUMBER' | translate | async }} {{ 'IS_NOT_VALID' | translate | async }}
            </app-form-error>
          </div>
          <div class="col-span-1 sm:order-3">
            <div class="text-[14px] font-medium leading-[21px] text-primary-color mb-[2px]">{{ 'EXPIRY_DATE' | translate | async }} <span class="text-field-required">*</span></div>
            <div
              #expiryDate
              class="h-[40px] bg-background-primary-color rounded-[10px] px-[16px] py-[9.5px] border border-border-color"
              data-cse="encryptedExpiryDate"
              [ngClass]="{
                'border-error-color': (isExpiryDateFocus$ | async) && !(this.isExpiryDateValid$ | async)
              }"
            ></div>
            <app-form-error *ngIf="(isExpiryDateFocus$ | async) && !(this.isExpiryDateValid$ | async)">
              {{ 'EXPIRY_DATE' | translate | async }} {{ 'IS_NOT_VALID' | translate | async }}
            </app-form-error>
          </div>
          <div class="col-span-1 sm:col-span-2">
            <div class="text-[14px] font-medium leading-[21px] text-primary-color mb-[2px]">{{ 'CARDHOLDER_NAME' | translate | async }} <span class="text-field-required">*</span></div>
            <app-input
              [control]="rfPayment?.get('accountHolder')"
              [customClass]="'!h-[40px] mb-[6px] bg-background-primary-color rounded-[10px] px-[16px] py-[9.5px] border border-border-color'"
              [isRequired]="true"
              formControlName="accountHolder"
              type="text"
            >
              <app-form-error *ngIf="rfPayment?.get('accountHolder').hasError('required') && rfPayment?.get('accountHolder').touched">
                {{ 'CARDHOLDER_NAME' | translate | async }} {{ 'IS_REQUIRED' | translate | async }}
              </app-form-error>
              <app-form-error *ngIf="rfPayment?.get('accountHolder').hasError('pattern') && rfPayment?.get('accountHolder').touched">
                {{ 'CARDHOLDER_NAME' | translate | async }} {{ 'IS_NOT_VALID' | translate | async }}
              </app-form-error>
            </app-input>
          </div>
          <div class="col-span-1 sm:order-last">
            <div class="text-[14px] font-medium leading-[21px] text-primary-color mb-[2px]">{{ 'CVV' | translate | async }} <span class="text-field-required">*</span></div>
            <div
              #cvv
              class="h-[40px] bg-background-primary-color rounded-[10px] px-[16px] py-[9.5px] border border-border-color"
              data-cse="encryptedSecurityCode"
              [ngClass]="{
                'border-error-color': (isCVVFocus$ | async) && !(this.isCVVValid$ | async)
              }"
            ></div>
            <app-form-error *ngIf="(isCVVFocus$ | async) && !(this.isCVVValid$ | async)"> {{ 'CVV' | translate | async }} {{ 'IS_NOT_VALID' | translate | async }} </app-form-error>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</ng-template>

<ng-template #tplDefaultGuarantee let-mode>
  <div
    class="mt-[16px] text-[14px] font-normal leading-[120%] text-primary-color"
    [innerHTML]="mode?.paymentMethodDetailsList[0]?.metadata?.value || mode?.paymentMethodDetailsList[0]?.metadata?.metadata?.description"
  ></div>
</ng-template>

<ng-template #tplLoading>
  <button
    class="h-[44px] text-[14px] font-medium leading-[140%] whitespace-nowrap text-button-normal-color bg-border-color rounded-[12px] sm:w-full sm:flex sm:justify-center px-[24px] cursor-not-allowed flex items-center justify-center"
  >
    <span class="loader block"></span>
    <span>{{ 'PROCESSING' | translate | async }}</span>
  </button>
</ng-template>
